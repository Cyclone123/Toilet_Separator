C51 COMPILER V7.06   TOILET                                                                11/07/2017 15:34:42 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE TOILET
OBJECT MODULE PLACED IN toilet.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE toilet.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          /*------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ---------------------------------------------*/
   3          /* --- STC12C56xx Series Programmable Clock Output Demo ------------*/
   4          /* --- Mobile: (86)13922805190 -------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ---------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966----------------------*/
   7          /* --- Web: www.STCMCU.com -----------------------------------------*/
   8          /* --- Web: www.GXWMCU.com -----------------------------------------*/
   9          /* If you want to use the program or the program referenced in the  */
  10          /* article, please specify in which data and procedures from STC    */
  11          /*------------------------------------------------------------------*/
  12          
  13          #include "STC12C20XX.h"
  14          
  15          
  16          sbit Watchdog=P3^7;  //看门狗输出
  17          
  18          sbit Relay1=P3^0;  
  19          sbit Relay2=P3^1;  
  20          
  21          sbit Forward  =P1^4;  
  22          sbit Backward =P1^5;  
  23          sbit Button   =P1^7;  
  24          
  25          sbit InOut1=P1^0;  
  26          sbit InOut2=P1^1;  
  27          sbit InOut3=P1^2;  
  28          sbit InOut4=P1^3;  
  29          
  30          
  31          unsigned int Timer_50mS;
  32          unsigned int Timer_1S;
  33          unsigned int TimerOut;
  34          
  35          void Delay_ms (unsigned int a);
  36          void Delay_2S(void);
  37          void Timer0Init (void);
  38          void RelayOutInit (void);
  39          void StepLightInit(void);
  40          
  41          void StepLight(unsigned int Step);
  42          
  43          unsigned int PutButtonDown(void);
  44          unsigned int GetPointForward(void);
  45          unsigned int GetPointBackward(void);
  46          
  47          void MotorMotionForward(void);
  48          void MotorMotionReverse(void);
  49          void MotorStopMotion(void);
  50          void MotorMotionHome(void);
  51          
  52          
  53          /*--------------------------------------主函数--------------------------------------*/
  54          void main(void)
  55          {
C51 COMPILER V7.06   TOILET                                                                11/07/2017 15:34:42 PAGE 2   

  56   1              Timer0Init(); 
  57   1      
  58   1              ET0=1;                  //开定时器中断
  59   1              EA=1;                   //开总中断
  60   1              TR0=1;                  //启动定时器
  61   1      
  62   1              RelayOutInit();
  63   1              StepLightInit();
  64   1      
  65   1              Timer_50mS= 0 ;
  66   1              Timer_1S = 0 ;
  67   1              TimerOut = 0 ;
  68   1      
  69   1              MotorMotionHome();
  70   1      
  71   1              while(1)
  72   1              {
  73   2                      StepLight(1);
  74   2                      while(!PutButtonDown());
  75   2      
  76   2                      StepLight(2);
  77   2                      MotorMotionForward();
  78   2      
  79   2                      StepLight(3);
  80   2                      MotorStopMotion();
  81   2                      Delay_2S();
  82   2      
  83   2                      StepLight(4);
  84   2                      MotorMotionReverse();
  85   2      
  86   2                      Delay_2S();
  87   2              }
  88   1      }
  89          
  90          
  91          /*-----------------------------------中断服务程序-----------------------------------*/
  92          void Timer0_Rountine(void) interrupt 1 
  93          {
  94   1              TH0=0x3C;                       //重新装载定时器时基值
  95   1              TL0=0xB0;
  96   1      
  97   1          Timer_50mS++;
  98   1      
  99   1              if (Timer_50mS==20)
 100   1              {                                       //定时器循环计数20次为一秒
 101   2                      Timer_50mS=0;   //次数清零，从新循环计数
 102   2                      Timer_1S++;             //秒加一
 103   2              }
 104   1      
 105   1              if(Timer_1S >= 20)      //当电机运行时间超过此设定时间后，置位标志位TimeOut.
 106   1              {
 107   2                      Timer_1S = 0;
 108   2                      TimerOut = 1 ;
 109   2              }
 110   1      
 111   1              Watchdog=~Watchdog;             //喂狗
 112   1      }
 113          
 114          
 115          /*----------------------------------定时器初始化函数----------------------------------*/
 116          void Timer0Init (void)
 117          {   
C51 COMPILER V7.06   TOILET                                                                11/07/2017 15:34:42 PAGE 3   

 118   1              TMOD=0x01;                              //定时器工作方式1:16位
 119   1      
 120   1              TH0=(65536-50000)/256;  //定时时间50ms
 121   1              TL0=(65536-50000)%256;
 122   1      } 
 123          
 124          
 125          /*----------------------------------继电器/输出口初始化函数----------------------------------*/
 126          void RelayOutInit (void)
 127          {   
 128   1              P3M0=0x00;                              //P3口工作方式:强推挽输出
 129   1              P3M1=0xff;      
 130   1      
 131   1              Relay1=1;  
 132   1              Relay2=1;  
 133   1      } 
 134          
 135          
 136          /*----------------------------------运行步骤指示LED灯输出口初始化函数----------------------------------*/
 137          void StepLightInit(void)
 138          {
 139   1              P1M0=0x00;                              //P1口工作方式:强推挽输出
 140   1              P1M1=0x0f;      
 141   1      
 142   1              InOut1=0;  
 143   1              InOut2=0;  
 144   1              InOut3=0;  
 145   1              InOut4=0;  
 146   1      }
 147          
 148          /*-------------------------------------延时函数-------------------------------------*/
 149          void Delay_ms (unsigned int a)
 150          {
 151   1              unsigned int i;
 152   1              while( --a != 0)
 153   1              {
 154   2                      for(i = 0; i < 600; i++);
 155   2              }
 156   1      }
 157          
 158          
 159          /*-------------------------------------长延时函数-------------------------------------*/
 160          void Delay_2S()
 161          {
 162   1              Delay_ms(1000);
 163   1              Delay_ms(1000);
 164   1      }
 165          
 166          
 167          /*----------------------------------启动按钮检测函数----------------------------------*/
 168          //当按纽按下，函数返回1；否则，函数返回0
 169          unsigned int PutButtonDown(void)
 170          {
 171   1              unsigned int Flag;
 172   1              Flag = 0 ;
 173   1      
 174   1              if(Button==0)
 175   1              {
 176   2                      Delay_ms(100);
 177   2      
 178   2                      if(Button==0)
 179   2                              Flag = 1 ;
C51 COMPILER V7.06   TOILET                                                                11/07/2017 15:34:42 PAGE 4   

 180   2              }
 181   1      
 182   1              return (Flag);
 183   1      }
 184          
 185          
 186          /*----------------------------------工作步骤指示LED显示函数----------------------------------*/
 187          void StepLight(unsigned int Step)
 188          {
 189   1              switch(Step)
 190   1              {
 191   2                      case 1: InOut1=1;
 192   2                                      InOut2=0;
 193   2                                      InOut3=0;
 194   2                                      InOut4=0;
 195   2                                      break;
 196   2                      case 2: InOut1=0;
 197   2                                      InOut2=1;
 198   2                                      InOut3=0;
 199   2                                      InOut4=0;
 200   2                                      break;
 201   2                      case 3: InOut1=0;
 202   2                                      InOut2=0;
 203   2                                      InOut3=1;
 204   2                                      InOut4=0;
 205   2                                      break;
 206   2                      case 4: InOut1=0;
 207   2                                      InOut2=0;
 208   2                                      InOut3=0;
 209   2                                      InOut4=1;
 210   2                                      break;
 211   2                      default:InOut1=0;
 212   2                                      InOut2=0;
 213   2                                      InOut3=0;
 214   2                                      InOut4=0;
 215   2              }
 216   1      }
 217          
 218          
 219          
 220          /*----------------------------------电机向前动作到停止点函数----------------------------------*/
 221          void MotorMotionForward(void)
 222          {
 223   1              Relay1 =1;
 224   1              Relay2 =0;
 225   1      
 226   1              Timer_1S =0;
 227   1              TimerOut =0;
 228   1      
 229   1              while(!GetPointForward());
 230   1      
 231   1              Relay1 =1;
 232   1              Relay2 =1;
 233   1      }
 234          
 235          
 236          /*----------------------------------电机向后动作到停止点函数----------------------------------*/
 237          void MotorMotionReverse(void)
 238          {
 239   1              Relay1 =0;
 240   1              Relay2 =1;
 241   1      
C51 COMPILER V7.06   TOILET                                                                11/07/2017 15:34:42 PAGE 5   

 242   1              Timer_1S =0;
 243   1              TimerOut =0;
 244   1      
 245   1              while(!GetPointBackward());
 246   1      
 247   1              Relay1 =1;
 248   1              Relay2 =1;
 249   1      }
 250          
 251          
 252          /*----------------------------------电机停止动作函数----------------------------------*/
 253          void MotorStopMotion(void)
 254          {
 255   1              Relay1 =1;
 256   1              Relay2 =1;
 257   1      }
 258          
 259          
 260          
 261          /*----------------------------------电机回到初始位置函数----------------------------------*/
 262          void MotorMotionHome(void)
 263          {
 264   1              if(!GetPointBackward())
 265   1              {
 266   2                      MotorMotionReverse();
 267   2              }
 268   1      }
 269          
 270          
 271          /*----------------------------------电机到达前停止点检测函数----------------------------------*/
 272          //电机到达前停止位，函数返回1；否则函数返回0
 273          unsigned int GetPointForward(void)
 274          {
 275   1              unsigned int Point;
 276   1              
 277   1              Point=0;
 278   1              
 279   1              if(Forward==0 || TimerOut==1)
 280   1                      Point=1;
 281   1      
 282   1              return(Point);
 283   1      }
 284          
 285          
 286          /*----------------------------------电机到达后停止点检测函数----------------------------------*/
 287          //电机到达后停止位，函数返回1；否则函数返回0
 288          unsigned int GetPointBackward(void)
 289          {
 290   1              unsigned int Point;
 291   1              
 292   1              Point=0;
 293   1              
 294   1              if(Backward==0 || TimerOut==1)
 295   1                      Point=1;
 296   1      
 297   1              return(Point);
 298   1      }
 299          
 300          
 301          
 302          
 303          
C51 COMPILER V7.06   TOILET                                                                11/07/2017 15:34:42 PAGE 6   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    408    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
