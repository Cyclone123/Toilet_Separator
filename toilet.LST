C51 COMPILER V7.06   TOILET                                                                09/23/2018 12:17:52 PAGE 1   


C51 COMPILER V7.06, COMPILATION OF MODULE TOILET
OBJECT MODULE PLACED IN toilet.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE toilet.c BROWSE DEBUG OBJECTEXTEND

stmt level    source

   1          /*------------------------------------------------------------------*/
   2          /* --- STC MCU Limited ---------------------------------------------*/
   3          /* --- STC12C56xx Series Programmable Clock Output Demo ------------*/
   4          /* --- Mobile: (86)13922805190 -------------------------------------*/
   5          /* --- Fax: 86-0513-55012956,55012947,55012969 ---------------------*/
   6          /* --- Tel: 86-0513-55012928,55012929,55012966----------------------*/
   7          /* --- Web: www.STCMCU.com -----------------------------------------*/
   8          /* --- Web: www.GXWMCU.com -----------------------------------------*/
   9          /* If you want to use the program or the program referenced in the  */
  10          /* article, please specify in which data and procedures from STC    */
  11          /*------------------------------------------------------------------*/
  12          
  13          //20180824修改版，根据出现的问题，调整精确定时时间，电机前进后退都是6秒，中间间隔4秒。
  14          //为了防止限位器故障，导致电机不动作。现将逻辑修改为：电机现动作5秒，再判断到达限位开关。
  15          
  16          //20180825修改版，添加上电后电机自动运行一个流程，用于确定电机电路是否正常。
  17          //20180827修改，将定时时间由7秒改为6秒，原时间较长。
  18          //20180923修改，还是用行程开关来确定电机工作位置。并把电机运行时间加长(15秒)，防止限位失灵，程序死循环
  19          #include "STC12C20XX.h"
  20          
  21          sbit Watchdog=P3^7;             //看门狗输出
  22          
  23          sbit Relay1=P3^0;  
  24          sbit Relay2=P3^1;  
  25          
  26          sbit Forward  =P1^7;            //电机反转限位开关点
  27          sbit Backward =P1^6;            //电机零位限位开关点 
  28          sbit Button   =P1^4;  
  29          
  30          sbit InOut1=P1^0;  
  31          sbit InOut2=P1^1;  
  32          sbit InOut3=P1^2;  
  33          sbit InOut4=P1^3;  
  34          
  35          
  36          unsigned int Timer_1mS;
  37          unsigned int Timer_1S;
  38          unsigned int TimerOut;
  39          
  40          void Delay_ms (unsigned int a);
  41          void Delay_4S(void);
  42          void Timer0Init (void);
  43          void RelayOutInit (void);
  44          void StepLightInit(void);
  45          
  46          void StepLight(unsigned int Step);
  47          
  48          unsigned int PutButtonDown(void);
  49          unsigned int GetPointForward(void);
  50          unsigned int GetPointBackward(void);
  51          
  52          void MotorMotionForward(void);
  53          void MotorMotionReverse(void);
  54          void MotorStopMotion(void);
  55          void MotorMotionHome(void);
C51 COMPILER V7.06   TOILET                                                                09/23/2018 12:17:52 PAGE 2   

  56          
  57          
  58          /*--------------------------------------主函数--------------------------------------*/
  59          void main(void)
  60          {
  61   1              Timer0Init(); 
  62   1      
  63   1              ET0=1;                  //开定时器中断
  64   1              EA=1;                   //开总中断
  65   1              TR0=1;                  //启动定时器
  66   1      
  67   1              RelayOutInit();
  68   1              StepLightInit();
  69   1      
  70   1              Timer_1mS= 0 ;
  71   1              Timer_1S = 0 ;
  72   1              TimerOut = 0 ;
  73   1      
  74   1              MotorMotionHome();
  75   1              Delay_4S();
  76   1              MotorMotionForward();
  77   1              Delay_4S();
  78   1              MotorStopMotion();
  79   1              Delay_4S();
  80   1              MotorMotionReverse();
  81   1              Delay_4S();
  82   1      
  83   1              while(1)
  84   1              {
  85   2                      StepLight(1);
  86   2                      while(!PutButtonDown());
  87   2      
  88   2                      StepLight(2);
  89   2                      MotorMotionForward();
  90   2      
  91   2                      StepLight(3);
  92   2                      MotorStopMotion();
  93   2                      Delay_4S();
  94   2      
  95   2                      StepLight(4);
  96   2                      MotorMotionReverse();
  97   2      
  98   2                      Delay_4S();
  99   2              }
 100   1      }
 101          
 102          
 103          /*-----------------------------------中断服务程序-----------------------------------*/
 104          void Timer0_Rountine(void) interrupt 1 
 105          {
 106   1              TH0=0xFE;       
 107   1              TL0=0x3E;                               //重新装载定时器时基值
 108   1      
 109   1          Timer_1mS++;
 110   1      
 111   1              if (Timer_1mS==1000)
 112   1              {                                                       //定时器循环计数1000次为一秒
 113   2                      Timer_1mS=0;                    //次数清零，从新循环计数
 114   2                      Timer_1S++;                             //秒加一
 115   2                      Watchdog=~Watchdog;             //喂狗
 116   2              }
 117   1      
C51 COMPILER V7.06   TOILET                                                                09/23/2018 12:17:52 PAGE 3   

 118   1              if(Timer_1S >= 12)      //当电机运行时间超过此设定时间后，置位标志位TimeOut.
 119   1              {
 120   2                      Timer_1S = 0;
 121   2                      TimerOut = 1 ;
 122   2              }       
 123   1      }
 124          
 125          
 126          /*----------------------------------定时器初始化函数----------------------------------*/
 127          void Timer0Init (void)
 128          {   
 129   1              TMOD=0x01;                              //定时器工作方式1:16位
 130   1      
 131   1              TH0=0xFE;       
 132   1              TL0=0x3E;                                       //定时时间1ms
 133   1      } 
 134          
 135          
 136          /*----------------------------------继电器/输出口初始化函数----------------------------------*/
 137          void RelayOutInit (void)
 138          {   
 139   1              P3M0=0x00;                              //P3口工作方式:强推挽输出
 140   1              P3M1=0xff;      
 141   1      
 142   1              Relay1=1;  
 143   1              Relay2=1;  
 144   1      } 
 145          
 146          
 147          /*----------------------------------运行步骤指示LED灯输出口初始化函数----------------------------------*/
 148          void StepLightInit(void)
 149          {
 150   1              P1M0=0x00;                              //P1口工作方式:强推挽输出
 151   1              P1M1=0x0f;      
 152   1      
 153   1              InOut1=1;  
 154   1              InOut2=1;  
 155   1              InOut3=1;  
 156   1              InOut4=1;  
 157   1      }
 158          
 159          /*-------------------------------------延时函数-------------------------------------*/
 160          void Delay_ms (unsigned int a)
 161          {
 162   1              unsigned int i;
 163   1              while( --a != 0)
 164   1              {
 165   2                      for(i = 0; i < 600; i++);
 166   2              }
 167   1      }
 168          
 169          
 170          /*-------------------------------------长延时函数-------------------------------------*/
 171          void Delay_4S()
 172          {
 173   1              Delay_ms(1000);
 174   1              Delay_ms(1000);
 175   1      }
 176          
 177          
 178          /*----------------------------------启动按钮检测函数----------------------------------*/
 179          //当按纽按下，函数返回1；否则，函数返回0
C51 COMPILER V7.06   TOILET                                                                09/23/2018 12:17:52 PAGE 4   

 180          unsigned int PutButtonDown(void)
 181          {
 182   1              unsigned int Flag;
 183   1              Flag = 0 ;
 184   1      
 185   1              if(Button==0)
 186   1              {
 187   2                      Delay_ms(100);
 188   2      
 189   2                      if(Button==0)
 190   2                              Flag = 1 ;
 191   2              }
 192   1      
 193   1              return (Flag);
 194   1      }
 195          
 196          
 197          /*----------------------------------工作步骤指示LED显示函数----------------------------------*/
 198          void StepLight(unsigned int Step)
 199          {
 200   1              switch(Step)
 201   1              {
 202   2                      case 1: InOut1=0;
 203   2                                      InOut2=1;
 204   2                                      InOut3=1;
 205   2                                      InOut4=1;
 206   2                                      break;
 207   2                      case 2: InOut1=1;
 208   2                                      InOut2=0;
 209   2                                      InOut3=1;
 210   2                                      InOut4=1;
 211   2                                      break;
 212   2                      case 3: InOut1=1;
 213   2                                      InOut2=1;
 214   2                                      InOut3=0;
 215   2                                      InOut4=1;
 216   2                                      break;
 217   2                      case 4: InOut1=1;
 218   2                                      InOut2=1;
 219   2                                      InOut3=1;
 220   2                                      InOut4=0;
 221   2                                      break;
 222   2                      default:InOut1=1;
 223   2                                      InOut2=1;
 224   2                                      InOut3=1;
 225   2                                      InOut4=1;
 226   2              }
 227   1      }
 228          
 229          
 230          
 231          /*----------------------------------电机向前动作到停止点函数----------------------------------*/
 232          void MotorMotionForward(void)
 233          {
 234   1              Relay1 =1;
 235   1              Relay2 =0;
 236   1      
 237   1              Timer_1mS=0;
 238   1              Timer_1S =0;
 239   1              TimerOut =0;
 240   1      
 241   1              while(Timer_1S<5);
C51 COMPILER V7.06   TOILET                                                                09/23/2018 12:17:52 PAGE 5   

 242   1      
 243   1              while(!GetPointForward());
 244   1      
 245   1              Relay1 =1;
 246   1              Relay2 =1;
 247   1      }
 248          
 249          
 250          /*----------------------------------电机向后动作到停止点函数----------------------------------*/
 251          void MotorMotionReverse(void)
 252          {
 253   1              Relay1 =0;
 254   1              Relay2 =1;
 255   1      
 256   1              Timer_1mS=0;
 257   1              Timer_1S =0;
 258   1              TimerOut =0;
 259   1      
 260   1              while(Timer_1S<5);
 261   1      
 262   1              while(!GetPointBackward());
 263   1      
 264   1              Relay1 =1;
 265   1              Relay2 =1;
 266   1      }
 267          
 268          
 269          /*----------------------------------电机停止动作函数----------------------------------*/
 270          void MotorStopMotion(void)
 271          {
 272   1              Relay1 =1;
 273   1              Relay2 =1;
 274   1      }
 275          
 276          
 277          
 278          /*----------------------------------电机回到初始位置函数----------------------------------*/
 279          void MotorMotionHome(void)
 280          {
 281   1      
 282   1              Relay1 =0;
 283   1              Relay2 =1;
 284   1      
 285   1              Timer_1mS=0;
 286   1              Timer_1S =0;
 287   1              TimerOut =0;
 288   1      
 289   1              while(!GetPointBackward());
 290   1      
 291   1              Relay1 =1;
 292   1              Relay2 =1;
 293   1      
 294   1      }
 295          
 296          
 297          /*----------------------------------电机到达前停止点检测函数----------------------------------*/
 298          //电机到达前停止位，函数返回1；否则函数返回0
 299          unsigned int GetPointForward(void)
 300          {
 301   1              unsigned int Point;
 302   1              
 303   1              Point=0;
C51 COMPILER V7.06   TOILET                                                                09/23/2018 12:17:52 PAGE 6   

 304   1              
 305   1              if(Forward==0 || TimerOut==1)
 306   1                      Point=1;
 307   1      
 308   1              return(Point);
 309   1      }
 310          
 311          
 312          /*----------------------------------电机到达后停止点检测函数----------------------------------*/
 313          //电机到达后停止位，函数返回1；否则函数返回0
 314          unsigned int GetPointBackward(void)
 315          {
 316   1              unsigned int Point;
 317   1              
 318   1              Point=0;
 319   1              
 320   1              if(Backward==0 || TimerOut==1)
 321   1                      Point=1;
 322   1      
 323   1              return(Point);
 324   1      }
 325          
 326          
 327          
 328          
 329          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    481    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
